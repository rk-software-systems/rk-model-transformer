using System.Collections.Frozen;
using Microsoft.CodeAnalysis;
using RKSoftware.Packages.ModelTransformer.Helpers;
using RKSoftware.Packages.ModelTransformer.Models;

namespace RKSoftware.Packages.ModelTransformer.Generations;

internal static class ModelExtensionGeneration
{
    private static readonly string _newLine = new('\n', 1);

    private static readonly string _indent1 = new('\t', 1);
    private static readonly string _indent2 = new('\t', 2);
    private static readonly string _indent3 = new('\t', 3);
    private static readonly string _indent4 = new('\t', 4);
    private static readonly string _indent5 = new('\t', 5);

    public static string GenerateExtensionClass(string hostNamespace, string sourceName, List<string> methods)
    {
        var methodsCode = string.Empty;
        if (methods.Count > 0)
        {
            methodsCode = string.Join(_newLine, methods);
        }

        var str = $@"
// <auto-generated>
#nullable enable

namespace {hostNamespace}
{{
{_indent1}public static partial class {sourceName}Extensions
{_indent1}{{
{_indent2}{methodsCode}
{_indent1}}}    
}}";
        return str;
    }


    public static string GenerateExtensionMethod(AttributeDataModel attr, Dictionary<string, List<AttributeDataModel>> dic)
    {
        var variableCreationCode = string.Empty;
        var methodsCode = string.Empty;
        var constructorVariableMappingCode = string.Empty;
        var postConstructorVariableMappingCode = string.Empty;
        var variableMappingCode = string.Empty;

        var mappings = GeneratePropertyMappings(attr, dic);

        if (mappings.Count > 0)
        {
            var variableCreations = mappings
                .Select(x => x.VariableCreationCode)
                .Where(x => !string.IsNullOrWhiteSpace(x))
                .ToList();

            if (variableCreations.Count > 0)
            {
                variableCreationCode = $"{_newLine}{string.Join($"{_newLine}{_newLine}", variableCreations)}{_newLine}";
            }

            var constructorVariableMappings = mappings
                .Select(x => x.ConstructorVariableMappingCode)
                .Where(x => !string.IsNullOrWhiteSpace(x))
                .ToList();

            if (constructorVariableMappings.Count > 0)
            {
                constructorVariableMappingCode = $"{_newLine}{string.Join($",{_newLine}", constructorVariableMappings)}";
            }

            var postConstructorVariableMappings = mappings
                .Select(x => x.PostConstructorVariableMappingCode)
                .Where(x => !string.IsNullOrWhiteSpace(x))
                .ToList();

            if (postConstructorVariableMappings.Count > 0)
            {
                postConstructorVariableMappingCode = string.Join($",{_newLine}", postConstructorVariableMappings);
            }

            var variableMappings = mappings
                .Select(x => x.VariableMappingCode)
                .Where(x => !string.IsNullOrWhiteSpace(x))
                .ToList();

            if (variableMappings.Count > 0)
            {
                variableMappingCode = string.Join($"{_newLine}", variableMappings);
            }

            var methods = mappings
                .Select(x => x.MethodCode)
                .Where(x => !string.IsNullOrWhiteSpace(x))
                .ToList();

            if (methods.Count > 0)
            {
                methodsCode = $"{_newLine}{string.Join($"{_newLine}{_newLine}", methods)}{_newLine}";
            }
        }

        var str = $@"
{_indent2}#region to {attr.Target.Name}

{_indent2}public static {attr.Target.ToDisplayString()} Transform (this {attr.Source.ToDisplayString()} source, {attr.Target.ToDisplayString()}? target = null)
{_indent2}{{
{_indent3}if (source == null) 
{_indent3}{{
{_indent4}throw new System.ArgumentNullException(nameof(source));
{_indent3}}}
{variableCreationCode}
{_indent3}if (target == null)
{_indent3}{{
{_indent4}target = new {attr.Target.ToDisplayString()} ({constructorVariableMappingCode})
{_indent4}{{
{postConstructorVariableMappingCode}
{_indent4}}};
{_indent3}}}
{_indent3}else
{_indent3}{{
{variableMappingCode}
{_indent3}}}
{_indent3}return target;
{_indent2}}}
{methodsCode}
{_indent2}#endregion
";
        return str;
    }

    #region helpers

    private static List<PropertyMappingModel> GeneratePropertyMappings(AttributeDataModel attr, Dictionary<string, List<AttributeDataModel>> dic)
    {
        var mappings = new List<PropertyMappingModel>();

        var targetProps = attr.TargetProperties;

        var constructorParams = attr.TargetConstructorParams;

        foreach (var targetProp in targetProps)
        {
            IPropertySymbol? sourceProp = null;
            var isRegistered = false;
            var isGenrericEnumerable = false;
            var isIgnored = attr.IgnoredProperties.TryGetValue(targetProp.Key, out _);
            if (!isIgnored)
            {
                if (attr.SourceProperties.TryGetValue(targetProp.Key, out sourceProp) &&
                    PropertySymbolHelper.CanNotConvertType(sourceProp, targetProp.Value))
                {
                    if (dic.TryGetValue(sourceProp.Type.OriginalDefinition.ToDisplayString(), out var complexTargets) &&
                        complexTargets.Any(x => SymbolEqualityComparer.Default.Equals(x.Target, targetProp.Value.Type)))
                    {
                        isRegistered = true;
                    }
                    else
                    {
                        var sourceElementType = PropertySymbolHelper.GetGenericElementType(sourceProp);
                        var targetElementType = PropertySymbolHelper.GetGenericElementType(targetProp.Value); 
                        if(sourceElementType != null && targetElementType != null &&
                           dic.TryGetValue(sourceElementType.OriginalDefinition.ToDisplayString(), out var complexElementTargets) &&
                           complexElementTargets.Any(x => SymbolEqualityComparer.Default.Equals(x.Target, targetElementType)))
                        {
                            isGenrericEnumerable = true;
                        }
                        else
                        {
                            sourceProp = null;
                        }                        
                    }
                }
            }
            var mapping = new PropertyMappingModel(targetProp.Value, attr.Target);

            if (!isIgnored)
            {
                CreateVariableCreationCode(mapping, sourceProp);
            }

            var variableName = isIgnored ? "default" : mapping.VariableName;
            CreateConstructorCode(mapping, constructorParams, variableName);

            if (!isIgnored)
            {
                CreateVariableMappingCode(mapping);

                CreateMethodCode(mapping, isRegistered, isGenrericEnumerable, targetProp.Value, sourceProp, attr);
            }

            mappings.Add(mapping);
        }

        return mappings;
    }
    #endregion

    private static void CreateVariableCreationCode(PropertyMappingModel mapping, IPropertySymbol? sourceProp)
    {
        if (sourceProp != null)
        {
            mapping.VariableCreationCode =
@$"{_indent3}var {mapping.VariableName} = {mapping.DefaultMethodName}(source);
{_indent3}{mapping.MethodName}(source, ref {mapping.VariableName});";
        }
        else
        {
            mapping.VariableCreationCode = @$"{_indent3}var {mapping.VariableName} = {mapping.MethodName}(source);";
        }
    }

    private static void CreateConstructorCode(PropertyMappingModel mapping, FrozenDictionary<string, IParameterSymbol> constructorParams, string variableName)
    {
        if (constructorParams.TryGetValue(mapping.PropertyName, out _))
        {
            mapping.ConstructorVariableMappingCode = $@"{_indent5}{mapping.PropertyName} : {variableName}";
        }
        else
        {
            mapping.PostConstructorVariableMappingCode = $@"{_indent5}{mapping.PropertyName} = {variableName}";
        }
    }

    private static void CreateVariableMappingCode(PropertyMappingModel mapping)
    {
        if (!mapping.IsReadonly)
        {
            mapping.VariableMappingCode = $@"{_indent4}target.{mapping.PropertyName} = {mapping.VariableName};";
        }
    }

    private static void CreateMethodCode(
        PropertyMappingModel mapping,
        bool isRegistered,
        bool isGenrericEnumerable,
        IPropertySymbol targetProp,
        IPropertySymbol? sourceProp,
        AttributeDataModel attr)
    {
        if (sourceProp != null)
        {
            var code = $"source.{sourceProp.Name}";
            if (isRegistered)
            {
                code = $"source.{sourceProp.Name}{(PropertySymbolHelper.IsNullable(sourceProp) ? "?" : "")}.Transform()";
            } 
            else if (isGenrericEnumerable)
            {
                var str = $"[.. source.{sourceProp.Name}.Select(x => x.Transform())]";
                code = PropertySymbolHelper.IsNullable(sourceProp) ? $"source.{sourceProp.Name} != null ? {str} : default" : str;
            }

            mapping.MethodCode =
    $@"{_indent2}private static {targetProp.Type.ToDisplayString()} {mapping.DefaultMethodName}({attr.Source.ToDisplayString()} source)
{_indent2}{{
{_indent3}return {code};
{_indent2}}}
{_indent2}static partial void {mapping.MethodName}({attr.Source.ToDisplayString()} source, ref {targetProp.Type.ToDisplayString()} target);";
        }
        else
        {
            mapping.MethodCode =
$@"{_indent2}private static partial {targetProp.Type.ToDisplayString()} {mapping.MethodName}({attr.Source.ToDisplayString()} source);";
        }
    }
}
